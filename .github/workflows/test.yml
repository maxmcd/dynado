name: test

on: { push: {} }

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v5
        with: { distribution: 'temurin', java-version: '21' }
      - name: Install Maelstrom
        env:
          MAELSTROM_VERSION: v0.2.4
        run: |
          set -euo pipefail
          curl -sSL https://github.com/jepsen-io/maelstrom/releases/download/${MAELSTROM_VERSION}/maelstrom.tar.bz2 -o /tmp/maelstrom.tar.bz2
          tar -xjf /tmp/maelstrom.tar.bz2 -C "${HOME}"
          echo "${HOME}/maelstrom" >> "${GITHUB_PATH}"
      - name: Verify Maelstrom install
        run: |
          set -euo pipefail
          command -v maelstrom
      - run: sudo apt-get update && sudo apt-get install -y gnuplot
      - name: Set up Go
        uses: actions/setup-go@v5
        with: { go-version: 'stable', cache: true }
      - name: Set up Bun
        uses: oven-sh/setup-bun@v1
        with: { bun-version: latest }
      - run: bun install
      - run: bun x tsc
      - run: bun x prettier --check ./src ./test
      - run: bun test
      - run: TEST_DYNAMODB_LOCAL=true bun test --timeout=60000
      - run: go test -v ./...
      - run: |
          maelstrom test -w txn-rw-register \
            --bin ./test/maelstrom/run-txn-rw-register \
            --rate 1000 \
            --time-limit 10 \
            --node-count 1 \
            --concurrency 10
      - run: |
          maelstrom test -w lin-kv \
            --bin ./test/maelstrom/run-lin-kv \
            --rate 1000 \
            --time-limit 10 \
            --node-count 1 \
            --concurrency 10
